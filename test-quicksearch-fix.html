<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickSearch Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>QuickSearch GraphQL Fix Test</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="loadPage()">1. Load Page</button>
        <button onclick="openSearch()">2. Open Search</button>
        <button onclick="typeSearch()">3. Type "bun"</button>
        <button onclick="checkNetworkRequests()">4. Check Network</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="log"></div>
    </div>

    <iframe id="testFrame" style="display:none;"></iframe>

    <script>
        const log = document.getElementById('log');
        let interceptedRequests = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
            interceptedRequests = [];
            addLog('Log cleared');
        }
        
        function loadPage() {
            addLog('Loading page http://localhost:3000/drafts/nav3...');
            const iframe = document.getElementById('testFrame');
            iframe.style.display = 'block';
            
            iframe.onload = function() {
                addLog('Page loaded', 'success');
                
                // Inject network monitoring
                try {
                    const iframeWindow = iframe.contentWindow;
                    const originalFetch = iframeWindow.fetch;
                    
                    iframeWindow.fetch = function(...args) {
                        const [url, options] = args;
                        
                        if (options && options.body) {
                            try {
                                const body = JSON.parse(options.body);
                                if (body.query) {
                                    // Log GraphQL queries
                                    const queryInfo = {
                                        url: url,
                                        query: body.query.substring(0, 500),
                                        hasImage: body.query.includes('image'),
                                        hasQuickSearch: body.query.includes('quickSearch'),
                                        hasProductView: body.query.includes('productView')
                                    };
                                    
                                    interceptedRequests.push(queryInfo);
                                    
                                    // Check for the error pattern
                                    const imageMatches = body.query.match(/image\s*\{/g);
                                    if (imageMatches && imageMatches.length > 1) {
                                        addLog(`⚠️ Found duplicate image fields (${imageMatches.length} occurrences)`, 'warning');
                                    }
                                    
                                    // Check if patch was applied
                                    if (body.query.includes('images {') && !body.query.includes('image {')) {
                                        addLog('✅ GraphQL query patched successfully', 'success');
                                    }
                                    
                                    addLog(`GraphQL Request: ${url.split('/').pop()}`, 'info');
                                    
                                    // Check for syntax errors
                                    const lines = body.query.split('\n');
                                    if (lines.length >= 77) {
                                        addLog(`Line 77: ${lines[76].trim()}`, 'info');
                                    }
                                }
                            } catch (e) {
                                // Not JSON
                            }
                        }
                        
                        return originalFetch.apply(this, args).then(response => {
                            const clonedResponse = response.clone();
                            clonedResponse.json().then(data => {
                                if (data.errors) {
                                    addLog(`❌ GraphQL Error: ${JSON.stringify(data.errors[0])}`, 'error');
                                } else if (data.data) {
                                    addLog('✅ GraphQL Response OK', 'success');
                                }
                            }).catch(() => {});
                            return response;
                        });
                    };
                    
                    addLog('Network monitoring injected', 'success');
                } catch (e) {
                    addLog('Failed to inject monitoring: ' + e.message, 'error');
                }
            };
            
            iframe.src = 'http://localhost:3000/drafts/nav3';
        }
        
        function openSearch() {
            const iframe = document.getElementById('testFrame');
            if (!iframe.src) {
                addLog('Please load the page first', 'warning');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument;
                const searchButton = iframeDoc.querySelector('.nav-search-button');
                
                if (searchButton) {
                    searchButton.click();
                    addLog('Search button clicked', 'success');
                } else {
                    addLog('Search button not found', 'error');
                }
            } catch (e) {
                addLog('Error: ' + e.message, 'error');
            }
        }
        
        function typeSearch() {
            const iframe = document.getElementById('testFrame');
            try {
                const iframeDoc = iframe.contentDocument;
                const searchInput = iframeDoc.querySelector('#search, input[type="search"]');
                
                if (searchInput) {
                    searchInput.value = 'bun';
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                    addLog('Typed "bun" in search input', 'success');
                    
                    // Wait and check for results
                    setTimeout(() => {
                        const dropdown = iframeDoc.querySelector('.search-results-dropdown');
                        if (dropdown) {
                            const cards = dropdown.querySelectorAll('.search-product-card');
                            addLog(`Found ${cards.length} product cards in dropdown`, 'success');
                        } else {
                            const autocomplete = iframeDoc.querySelector('#search_autocomplete, .search-autocomplete');
                            if (autocomplete && autocomplete.innerHTML) {
                                addLog('Autocomplete has content but no dropdown', 'warning');
                            } else {
                                addLog('No search dropdown appeared', 'warning');
                            }
                        }
                    }, 2000);
                } else {
                    addLog('Search input not found', 'error');
                }
            } catch (e) {
                addLog('Error: ' + e.message, 'error');
            }
        }
        
        function checkNetworkRequests() {
            addLog('=== Network Request Summary ===', 'info');
            addLog(`Total intercepted requests: ${interceptedRequests.length}`, 'info');
            
            interceptedRequests.forEach((req, index) => {
                addLog(`Request ${index + 1}:`, 'info');
                addLog(`  - Has 'image': ${req.hasImage}`, req.hasImage ? 'warning' : 'info');
                addLog(`  - Has 'quickSearch': ${req.hasQuickSearch}`, 'info');
                addLog(`  - Has 'productView': ${req.hasProductView}`, req.hasProductView ? 'success' : 'info');
            });
            
            if (interceptedRequests.length === 0) {
                addLog('No GraphQL requests intercepted yet', 'warning');
            }
        }
        
        // Auto-start
        window.onload = function() {
            addLog('Test page ready. Click "Load Page" to begin.', 'info');
        };
    </script>
</body>
</html>